<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPX ç·¨è¼¯èˆ‡ä¸‹è¼‰å·¥å…·</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="static/css/style.css">
</head>

<body>
  <div id="banner">
    <div class="leftbanner">
      <a href="https://store.pikminbloom.com/zh-Hant">
        <img id="biglogo" src='static/images/logo.png' alt='çš®å…‹æ•å¤§logo'>
      </a>
    </div>
  </div>
  
  <h2>GPX é»ä½ç·¨è¼¯å™¨</h2>

  <div id="nameloco">
    <label>åç¨±ï¼š</label>
    <input type="text" id="nameInput" placeholder="ä¾‹å¦‚ï¼šå°ä¸­æ¶ˆæ³¢å¡Š">
    <br>
    <label>ç¶“ç·¯åº¦ï¼š</label>
    <input type="text" id="coordInput" placeholder="24.018417,120.493877">
    <button onclick="addPoint()">æ–°å¢é»ä½</button>
  </div>

  <div id="mapControls">
  <label>
    <input type="checkbox" id="showLineCheckbox" onchange="toggleLine()"> é¡¯ç¤ºé»ä½é€£ç·š
  </label>
  <th id="tips">ä¿®æ”¹åº§æ¨™æ™‚å¯æ‹–æ›³åœ°åœ–ä¸Šçš„æ¨™è¨˜ä¿®æ”¹åº§æ¨™ï¼Œæ‹–æ›³å®Œæˆå¾Œæœƒè‡ªå‹•é–å®š</th>
</div>

  <div id="map"></div>

  <table id="pointTable">
    <thead>
      <tr><th>åç¨±</th><th>ç¶“ç·¯åº¦</th><th>æ“ä½œ</th></tr>
    </thead>
    <tbody></tbody>
  </table>
    
  <div id="gpxname">
    <label>æª”æ¡ˆåç¨±ï¼š</label>
    <input type="text" id="gpxnameInput" placeholder="è«‹è¼¸å…¥æª”å">
    <button id="downloadBtn" onclick="downloadGPX()">ä¸‹è¼‰ GPX</button>
  </div>

  

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  let points = [];
  let markers = [];
  let tempMarker = null; // æš«æ™‚æ¨™è¨˜

  // åˆå§‹åŒ–åœ°åœ–
  let map = L.map('map').setView([23.9739, 120.9820], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap è²¢ç»è€…'
  }).addTo(map);

  // é»æ“Šåœ°åœ– â†’ é¡¯ç¤ºæš«æ™‚æ¨™è¨˜ + å¡«å…¥åº§æ¨™
  map.on('click', function(e) {
    const lat = e.latlng.lat.toFixed(6);
    const lon = e.latlng.lng.toFixed(6);
    document.getElementById('coordInput').value = `${lat},${lon}`;

    if (tempMarker) map.removeLayer(tempMarker);
    tempMarker = L.marker([lat, lon]).addTo(map)
      .bindPopup(`æš«æ™‚æ¨™è¨˜<br>${lat}, ${lon}`)
      .openPopup();
  });

  // æ–°å¢é»ä½
function addPoint() {
  const name = document.getElementById('nameInput').value.trim();
  let coord = document.getElementById('coordInput').value.trim();

  if (!name || !coord) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");

  coord = coord.replace(/[()ï¼ˆï¼‰]/g, "").replace(/ï¼Œ/g, ",").replace(/\s+/g, "");
  const [lat, lon] = coord.split(',').map(x => x.trim());
  if (!lat || !lon || isNaN(lat) || isNaN(lon)) return alert("è«‹è¼¸å…¥æ­£ç¢ºæ ¼å¼ï¼Œä¾‹å¦‚ï¼š24.018417,120.493877");

  points.push({ name, lat, lon });
  renderTable();
  renderMarkers();

  document.getElementById('nameInput').value = '';
  document.getElementById('coordInput').value = '';

  // âœ… æ–°å¢é€™æ®µï¼šå¦‚æœç›®å‰æœ‰å‹¾é¸é¡¯ç¤ºç·šï¼Œæ–°å¢é»å¾Œè‡ªå‹•æ›´æ–°ç·š
  if (document.getElementById('showLineCheckbox')?.checked) {
    drawLine();
  }
}

  // é¡¯ç¤ºè¡¨æ ¼
  function renderTable() {
    const tbody = document.querySelector('#pointTable tbody');
    tbody.innerHTML = '';

    points.forEach((p, i) => {
      const coordText = `${p.lat},${p.lon}`;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td contenteditable="true" oninput="updatePoint(${i}, 'name', this.innerText)">${p.name}</td>
        <td contenteditable="true" oninput="updateCoord(${i}, this.innerText)">${coordText}</td>
        <td>
          <button onclick="editCoord(${i})">ä¿®æ”¹åº§æ¨™</button>
          <button onclick="deletePoint(${i})">åˆªé™¤</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  // æ›´æ–°åç¨±
  function updatePoint(index, key, value) {
    points[index][key] = value.trim();
    renderMarkers();
  }

  // æ›´æ–°ç¶“ç·¯åº¦
  function updateCoord(index, value) {
    const [lat, lon] = value.split(',').map(x => x.trim());
    if (!lat || !lon || isNaN(lat) || isNaN(lon)) return;
    points[index].lat = lat;
    points[index].lon = lon;
    renderMarkers();
  }

  // ä¿®æ”¹åº§æ¨™æŒ‰éˆ• â†’ å¯è¼¸å…¥æ–°åº§æ¨™
function editCoord(index) {
  const marker = markers[index];
  if (!marker) return;
  if (document.getElementById('showLineCheckbox').checked) drawLine();


  // å•Ÿç”¨æ‹–æ›³
  marker.dragging.enable();
  marker.openPopup();
}


  // åˆªé™¤è³‡æ–™
  function deletePoint(index) {
    if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é»å—ï¼Ÿ")) {
      points.splice(index, 1);
      renderTable();
      renderMarkers();
    }

    if (document.getElementById('showLineCheckbox')?.checked) {
         drawLine();}
  }

  // é¡¯ç¤ºåœ°åœ–æ¨™è¨˜
function renderMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  if (points.length === 0) return;

  const bounds = [];
  points.forEach((p, i) => {
    const marker = L.marker([p.lat, p.lon], { draggable: false })
      .bindPopup(`<b>${p.name}</b><br>${p.lat},${p.lon}`)
      .addTo(map);

    // ğŸ”¹ é€™è£¡åŠ ä¸Šæ‹–æ›³äº‹ä»¶
    marker.on('dragend', function(e) {
      const latlng = e.target.getLatLng();
      points[i].lat = latlng.lat.toFixed(6);
      points[i].lon = latlng.lng.toFixed(6);

      renderTable(); // æ›´æ–°è¡¨æ ¼
      marker.getPopup().setContent(`<b>${points[i].name}</b><br>${points[i].lat},${points[i].lon}`);

      marker.dragging.disable(); // æ‹–æ›³çµæŸå¾Œé–å®š

      // âœ… å¦‚æœç›®å‰æœ‰å‹¾é¸é¡¯ç¤ºé€£ç·šï¼Œæ‹–æ›³å¾Œè‡ªå‹•æ›´æ–°ç·š
      if (document.getElementById('showLineCheckbox')?.checked) {
        drawLine();
      }
    });

    markers.push(marker);
    bounds.push([p.lat, p.lon]);
  });

  if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
}

let polyline = null; // å­˜æ”¾é€£ç·šåœ–å±¤

// é¡¯ç¤ºæˆ–éš±è—é€£ç·š
function toggleLine() {
  const checked = document.getElementById('showLineCheckbox').checked;

  if (checked) {
    drawLine();
  } else {
    if (polyline) {
      map.removeLayer(polyline);
      polyline = null;
    }
  }
}

// ç•«ç·š
function drawLine() {
  if (polyline) map.removeLayer(polyline);

  if (points.length < 2) return; // å°‘æ–¼å…©é»ç„¡æ³•é€£ç·š

  const latlngs = points.map(p => [p.lat, p.lon]);
  polyline = L.polyline(latlngs, { color: 'red', weight: 3 }).addTo(map);
}


  // ä¸‹è¼‰ GPX
  function downloadGPX() {
    if (points.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯ä»¥ä¸‹è¼‰");
    
    let filename = document.getElementById('gpxnameInput').value.trim();
    if (!filename) filename = "points";
    if (!filename.toLowerCase().endsWith('.gpx')) filename += '.gpx';

    let gpx = `<?xml version="1.0" encoding="utf-8" standalone="yes"?>\n<gpx version="1.1" creator="GPX Editor" xmlns="http://www.topografix.com/GPX/1/1">\n`;
    points.forEach(p => {
      gpx += `  <wpt lat="${p.lat}" lon="${p.lon}"><name><![CDATA[${p.name}]]></name></wpt>\n`;
    });
    gpx += `</gpx>`;

    const blob = new Blob([gpx], { type: "application/gpx+xml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }
  </script>
</body>
</html>
