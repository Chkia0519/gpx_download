<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPX 編輯與下載工具</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="static/css/style.css">
</head>

<body>
  <div id="banner">
    <div class="leftbanner">
      <a href="https://store.pikminbloom.com/zh-Hant">
        <img id="biglogo" src='static/images/logo.png' alt='皮克敏大logo'>
      </a>
    </div>
  </div>
  
  <h2>GPX 點位編輯器</h2>

  <div id="nameloco">
    <label>名稱：</label>
    <input type="text" id="nameInput" placeholder="例如：台中消波塊">
    <br>
    <label>經緯度：</label>
    <input type="text" id="coordInput" placeholder="24.018417,120.493877">
    <button onclick="addPoint()">新增點位</button>
  </div>

  <div id="mapControls">
  <label>
    <input type="checkbox" id="showLineCheckbox" onchange="toggleLine()"> 顯示點位連線
  </label>
  <span id="tips">修改座標時可拖曳地圖上的標記修改座標，拖曳完成後會自動鎖定</span>
</div>

  <div id="map"></div>

  <table id="pointTable">
    <thead>
      <tr><th>名稱</th><th>經緯度</th><th>操作</th></tr>
    </thead>
    <tbody></tbody>
  </table>
    
  <div id="gpxname">
    <label>檔案名稱：</label>
    <input type="text" id="gpxnameInput" placeholder="請輸入檔名">
    <button id="downloadBtn" onclick="downloadGPX()">下載 GPX</button>
  </div>

  

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  let map;
let points = [];
let markers = [];
let tempMarker = null;
let firstAdd = true;
let pointCount = 0;

// 初始化地圖
function initMap() {
  map = L.map('map').setView([23.6978, 120.9605], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);

  const tips = document.getElementById("tips");
  tips.style.display = "none";

  // 點擊地圖：顯示暫時標記與提示
  map.on('click', (e) => {
    const { lat, lng } = e.latlng;

    if (tempMarker) map.removeLayer(tempMarker);
    tempMarker = L.marker([lat, lng]).addTo(map);
    tips.innerText = `點擊「加入座標」新增這個點 (${lat.toFixed(6)}, ${lng.toFixed(6)})`;
    tips.style.display = "block";

    // 點擊暫時標記直接新增
    tempMarker.on('click', () => addPoint(lat, lng));
  });
}

// 新增點位
function addPoint(lat, lon) {
  pointCount++;
  const name = `地點${pointCount}`;

  const newPoint = { name, lat, lon };
  points.push(newPoint);
  renderTable();
  renderMarkers();

  if (firstAdd) {
    map.setView([lat, lon], 16);
    firstAdd = false;
  }

  // 移除暫時標記與提示
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
  }
  document.getElementById("tips").style.display = "none";
}

// 重新渲染地圖標記
function renderMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  points.forEach((p, index) => {
    const marker = L.marker([p.lat, p.lon], { draggable: true }).addTo(map);
    marker.bindPopup(`${p.name}<br>(${p.lat.toFixed(6)}, ${p.lon.toFixed(6)})`);
    marker.on('dragend', (e) => {
      const { lat, lng } = e.target.getLatLng();
      points[index].lat = lat;
      points[index].lon = lng;
      renderTable();
    });
    markers.push(marker);
  });
}

// 重新渲染表格
function renderTable() {
  const tbody = document.querySelector('#pointTable tbody');
  tbody.innerHTML = '';

  points.forEach((p, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${p.name}" onchange="updateName(${index}, this.value)" /></td>
      <td>${p.lat.toFixed(6)}, ${p.lon.toFixed(6)}</td>
      <td>
        <button onclick="editCoords(${index})">修改座標</button>
        <button onclick="deletePoint(${index})">刪除</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// 修改名稱
function updateName(index, newName) {
  points[index].name = newName.trim() || `地點${index + 1}`;
  renderMarkers();
}

// 修改座標
function editCoords(index) {
  const input = prompt("請輸入新座標（格式：緯度,經度）", `${points[index].lat},${points[index].lon}`);
  if (!input) return;
  const [lat, lon] = input.replace(/[() ]/g, '').split(',').map(Number);
  if (isNaN(lat) || isNaN(lon)) return alert("格式錯誤，請輸入緯度,經度");
  points[index].lat = lat;
  points[index].lon = lon;
  renderTable();
  renderMarkers();
}

// 刪除點位
function deletePoint(index) {
  points.splice(index, 1);
  renderTable();
  renderMarkers();
}

window.onload = initMap;

  </script>
</body>
</html>
