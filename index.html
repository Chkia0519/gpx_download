<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPX 編輯與下載工具</title>
  <link rel="icon" href="favicon2.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="static/css/style.css">
</head>

<body>
  <div id="banner">
    <div class="leftbanner">
      <a href="https://store.pikminbloom.com/zh-Hant">
        <img id="biglogo" src='static/images/logo.png' alt='皮克敏大logo'>
      </a>
    </div>
  </div>
  
  <h2>GPX 點位編輯器</h2>

  <div id="nameloco">
    <label>名稱：</label>
    <input type="text" id="nameInput" placeholder="例如：台中消波塊">
    <br>
    <label>經緯度：</label>
    <input type="text" id="coordInput" placeholder="24.018417,120.493877">
    <button onclick="addPoint()">新增點位</button>
  </div>

  <div id="mapControls">
    <label>
      <input type="checkbox" id="showLineCheckbox" onchange="toggleLine()"> 顯示點位連線
    </label>
    <span id="tips">點擊地圖以加入座標</span>
    <span  style="display:none" id ="uptips">修改座標時可拖曳地圖上的標記修改座標，拖曳完成後會自動鎖定</span>
  </div>

  <div id="map"></div>

<div id="tableContainer">
  <table id="pointTable">
    <thead>
      <tr>
        <th>名稱</th>
        <th>經緯度</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="pointTableBody"></tbody>
  </table>
</div>
  
  <div id="gpxname">
    <label>檔案名稱：</label>
    <input type="text" id="gpxnameInput" placeholder="請輸入檔名">
    <button id="downloadBtn" onclick="downloadGPX()">下載 GPX</button>
    <button onclick="downloadJoystickGPX()">下載 Joystick GPX</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  let points = [];
  let markers = [];
  let tempMarker = null;
  let polyline = null;
  let pointCount = 0; // 自動編號用
  let isEditing = false;

  const uptips = document.getElementById('uptips');
  const tips = document.getElementById('tips');
  const map = L.map('map').setView([23.9739, 120.9820], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap 貢獻者'
  }).addTo(map);

  // 點擊地圖 → 顯示暫時標記 + 加入按鈕
 map.on('click', function(e) {
  if (isEditing) return;   // ★ 修改座標時禁用新增模式

  const lat = e.latlng.lat.toFixed(6);
  const lon = e.latlng.lng.toFixed(6);
  document.getElementById('coordInput').value = `${lat},${lon}`;

  if (tempMarker) map.removeLayer(tempMarker);

  tempMarker = L.marker([lat, lon]).addTo(map)
    .bindPopup(`<b>暫時標記</b><br>${lat}, ${lon}<br><button onclick="confirmAddPoint(${lat},${lon})">加入座標</button>`)
    .openPopup();

  tips.style.display = 'inline';
});

  // 確認新增點
  function confirmAddPoint(lat, lon) {
    pointCount++;
    const name = `點位 ${pointCount}`;
    points.push({ name, lat, lon });
    renderTable();
    renderMarkers();

    map.closePopup();
    map.removeLayer(tempMarker);
    tempMarker = null;
    tips.style.display = 'none';

    // 第一個點自動 zoom in
    if (points.length === 1) {
      map.setView([lat, lon], 15);
    }

    if (document.getElementById('showLineCheckbox').checked) drawLine();
  }

  // 新增點位（手動）
  function addPoint() {
    let name = document.getElementById('nameInput').value.trim();
    let coord = document.getElementById('coordInput').value.trim();

    if (!coord) return alert("請輸入經緯度或點擊地圖");

    coord = coord.replace(/[()（）]/g, "").replace(/，/g, ",").replace(/\s+/g, "");
    const [lat, lon] = coord.split(',').map(x => x.trim());
    if (!lat || !lon || isNaN(lat) || isNaN(lon)) return alert("請輸入正確格式，例如：24.018417,120.493877");

    if (!name) {
      pointCount++;
      name = `點位 ${pointCount}`;
    }

    points.push({ name, lat, lon });
    renderTable();
    renderMarkers();

    document.getElementById('nameInput').value = '';
    document.getElementById('coordInput').value = '';

    if (points.length === 1) map.setView([lat, lon], 15);
    if (document.getElementById('showLineCheckbox').checked) drawLine();
  }

  function renderTable() {
    const tbody = document.querySelector('#pointTable tbody');
    tbody.innerHTML = '';

    points.forEach((p, i) => {
      const coordText = `${p.lat},${p.lon}`;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td contenteditable="true" oninput="updatePoint(${i}, 'name', this.innerText)">${p.name}</td>
        <td contenteditable="true" oninput="updateCoord(${i}, this.innerText)">${coordText}</td>
        <td>
          <button onclick="editCoord(${i})">修改座標</button>
          <button onclick="deletePoint(${i})">刪除</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function updatePoint(index, key, value) {
    points[index][key] = value.trim();
    renderMarkers();
  }

  function updateCoord(index, value) {
    const [lat, lon] = value.split(',').map(x => x.trim());
    if (!lat || !lon || isNaN(lat) || isNaN(lon)) return;
    points[index].lat = lat;
    points[index].lon = lon;
    renderMarkers();
  }

  function editCoord(index) {
    const marker = markers[index];
    if (!marker) return;
    marker.dragging.enable();
    marker.openPopup();
  }

function startEditCoord(index) {
  const marker = markers[index];

  if (!marker) return;

  isEditing = true;   // ★ 開始修改模式
  uptips.style.display = 'inline';
  marker.dragging.enable();
  marker.openPopup();

  marker.once("dragend", function (e) {
    const latlng = e.target.getLatLng();
    points[index].lat = latlng.lat.toFixed(6);
    points[index].lon = latlng.lng.toFixed(6);

    renderTable();
    marker.dragging.disable();

    isEditing = false; // ★ 結束修改模式
    uptips.style.display = 'none';

    if (document.getElementById('showLineCheckbox').checked) drawLine();

  });
}
  function deletePoint(index) {
    if (confirm("確定要刪除這個點嗎？")) {
      points.splice(index, 1);
      renderTable();
      renderMarkers();
      if (document.getElementById('showLineCheckbox').checked) drawLine();
    }
  }

function renderMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  if (points.length === 0) return;

  points.forEach((p, i) => {

    function buildPopupHTML(index) {
      return `
        <b>${points[index].name}</b><br>${points[index].lat}, ${points[index].lon}<br>
        <button onclick="startEditCoord(${index})" style="margin-top:5px;">修改座標</button>
        <button onclick="deletePoint(${index})" style="margin-left:5px; color:red;">刪除</button>
      `;
    }

    const marker = L.marker([p.lat, p.lon], { draggable: false })
      .bindPopup(buildPopupHTML(i))
      .addTo(map);

    marker.on("dragend", function (e) {
  const latlng = e.target.getLatLng();
  points[i].lat = latlng.lat.toFixed(6);
  points[i].lon = latlng.lng.toFixed(6);

  renderTable();

  // 1. 先關閉 popup（舊內容）
  marker.closePopup();

  // 2. 更新 popup 內容
  marker.unbindPopup(); 
  marker.bindPopup(buildPopupHTML(i));

  // 3. 再關一次（避免 Leaflet 的延遲 popup）
  setTimeout(() => marker.closePopup(), 10);

  marker.dragging.disable();

  if (document.getElementById('showLineCheckbox').checked) drawLine();
});

    markers.push(marker);
  });
}

  function toggleLine() {
    if (document.getElementById('showLineCheckbox').checked) {
      drawLine();
    } else {
      if (polyline) {
        map.removeLayer(polyline);
        polyline = null;
      }
    }
  }

  function drawLine() {
    if (polyline) map.removeLayer(polyline);
    if (points.length < 2) return;
    const latlngs = points.map(p => [p.lat, p.lon]);
    polyline = L.polyline(latlngs, { color: 'red', weight: 3 }).addTo(map);
  }

  function downloadGPX() {
    if (points.length === 0) return alert("沒有資料可以下載");
    let filename = document.getElementById('gpxnameInput').value.trim() || "points";
    if (!filename.toLowerCase().endsWith('.gpx')) filename += '.gpx';
    let gpx = `<?xml version="1.0" encoding="utf-8"?>\n<gpx version="1.1" creator="GPX Editor" xmlns="http://www.topografix.com/GPX/1/1">\n`;
    points.forEach(p => {
      gpx += `  <wpt lat="${p.lat}" lon="${p.lon}"><name><![CDATA[${p.name}]]></name></wpt>\n`;
    });
    gpx += `</gpx>`;
    const blob = new Blob([gpx], { type: "application/gpx+xml" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
  }

  function downloadJoystickGPX() {
    if (points.length === 0) return alert("沒有資料可以下載");
  
    let filename = document.getElementById('gpxnameInput').value.trim() || "joystick";
    if (!filename.toLowerCase().endsWith('.gpx')) filename += '.gpx';
  
    let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n`;
    gpx += `<gpx version="1.1" creator="GPS JoyStick - gpsjoystick@gmail.com - https://www.facebook.com/gpsjoystick">\n`;
    gpx += `  <rte>\n`;
  
    points.forEach(p => {
      gpx += `    <rtept lat="${p.lat}" lon="${p.lon}"></rtept>\n`;
    });
  
    gpx += `  </rte>\n`;
    gpx += `</gpx>`;
  
    const blob = new Blob([gpx], { type: "application/gpx+xml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }
  </script>
</body>
</html>
