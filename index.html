<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPX ç·¨è¼¯èˆ‡ä¸‹è¼‰å·¥å…·</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="static/css/style.css">
</head>


<body>

  <div id="banner">
   <div class="leftbanner">
      <a href="https://store.pikminbloom.com/zh-Hant"><img id="biglogo" src='static/images/logo.png' alt='çš®å…‹æ•å¤§logo'></a>
    </div>
  </div>
  
<h2>GPX é»ä½ç·¨è¼¯å™¨</h2>

<div id="nameloco">
  <label>åç¨±ï¼š</label>
  <input type="text" id="nameInput" placeholder="ä¾‹å¦‚ï¼šå°ä¸­æ¶ˆæ³¢å¡Š">
  <br>
  <label>ç¶“ç·¯åº¦ï¼š</label>
  <input type="text" id="coordInput" placeholder="24.018417,120.493877">
  <button onclick="addPoint()">æ–°å¢é»ä½</button>
</div>

<div id="map"></div>

<table id="pointTable">
  <thead>
    <tr><th>åç¨±</th><th>ç¶“ç·¯åº¦</th><th>æ“ä½œ</th></tr>
  </thead>
  <tbody></tbody>
</table>
  
<div id="gpxname">
  <label>æª”æ¡ˆåç¨±ï¼š</label>
  <input type="text" id="gpxnameInput" placeholder="è«‹è¼¸å…¥æª”å">
  <button id="downloadBtn" onclick="downloadGPX()">ä¸‹è¼‰ GPX</button>
</div>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let points = [];
let map = L.map('map').setView([23.9739, 120.9820], 7); // å°ç£ä¸­å¿ƒé»
let markers = [];

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap è²¢ç»è€…'
}).addTo(map);

// æ–°å¢é»ä½
function addPoint() {
  const name = document.getElementById('nameInput').value.trim();
  let coord = document.getElementById('coordInput').value.trim();

  if (!name || !coord) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");

  // ğŸ”¹ è‡ªå‹•æ¸…ç†è¼¸å…¥å…§å®¹
  coord = coord
    .replace(/[()ï¼ˆï¼‰]/g, "") // å»é™¤æ‹¬è™Ÿ
    .replace(/ï¼Œ/g, ",")       // å…¨å½¢é€—è™Ÿæ›æˆåŠå½¢
    .replace(/\s+/g, "");      // ç§»é™¤æ‰€æœ‰ç©ºç™½

  const [lat, lon] = coord.split(',').map(x => x.trim());

  if (!lat || !lon || isNaN(lat) || isNaN(lon)) {
    return alert("è«‹è¼¸å…¥æ­£ç¢ºæ ¼å¼ï¼Œä¾‹å¦‚ï¼š24.018417,120.493877");
  }

  points.push({ name, lat, lon });
  renderTable();
  renderMarkers();

  document.getElementById('nameInput').value = '';
  document.getElementById('coordInput').value = '';
}

// é¡¯ç¤ºè¡¨æ ¼
function renderTable() {
  const tbody = document.querySelector('#pointTable tbody');
  tbody.innerHTML = '';

  points.forEach((p, i) => {
    const row = document.createElement('tr');
    const coordText = `${p.lat},${p.lon}`;

    row.innerHTML = `
      <td contenteditable="true" oninput="updatePoint(${i}, 'name', this.innerText)">${p.name}</td>
      <td contenteditable="true" oninput="updateCoord(${i}, this.innerText)">${coordText}</td>
      <td><button onclick="deletePoint(${i})">åˆªé™¤</button></td>
    `;

    tbody.appendChild(row);
  });
}

// æ›´æ–°åç¨±
function updatePoint(index, key, value) {
  points[index][key] = value.trim();
  renderMarkers();
}

// æ›´æ–°ç¶“ç·¯åº¦
function updateCoord(index, value) {
  const [lat, lon] = value.split(',').map(x => x.trim());
  if (!lat || !lon || isNaN(lat) || isNaN(lon)) return;
  points[index].lat = lat;
  points[index].lon = lon;
  renderMarkers();
}

// åˆªé™¤è³‡æ–™
function deletePoint(index) {
  if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é»å—ï¼Ÿ")) {
    points.splice(index, 1);
    renderTable();
    renderMarkers();
  }
}

// é¡¯ç¤ºåœ°åœ–æ¨™è¨˜
function renderMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  if (points.length === 0) return;

  const bounds = [];
  points.forEach(p => {
    const marker = L.marker([p.lat, p.lon])
      .bindPopup(`<b>${p.name}</b><br>${p.lat},${p.lon}`)
      .addTo(map);
    markers.push(marker);
    bounds.push([p.lat, p.lon]);
  });

  if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
}

// ä¸‹è¼‰ GPX
function downloadGPX() {
  if (points.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯ä»¥ä¸‹è¼‰");
  
    // å–å¾—ä½¿ç”¨è€…è¼¸å…¥çš„æª”å
  let filename = document.getElementById('gpxnameInput').value.trim();
  if (!filename) filename = "points"; // é è¨­æª”å
  if (!filename.toLowerCase().endsWith('.gpx')) filename += '.gpx'; // è‡ªå‹•è£œä¸Šå‰¯æª”å

  let gpx = `<?xml version="1.0" encoding="utf-8" standalone="yes"?>\n<gpx version="1.1" creator="GPX Editor" xmlns="http://www.topografix.com/GPX/1/1">\n`;

  points.forEach(p => {
    gpx += `  <wpt lat="${p.lat}" lon="${p.lon}"><name><![CDATA[${p.name}]]></name></wpt>\n`;
  });

  gpx += `</gpx>`;

  const blob = new Blob([gpx], { type: "application/gpx+xml" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
