<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPX ç·¨è¼¯èˆ‡ä¸‹è¼‰å·¥å…·</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="static/css/style.css">

  <style>#map{height:500px; margin-top:15px; border-radius:8px; position:relative; z-index:0;}</style>
</head>

<body>
  <div id="banner">
    <div class="leftbanner">
      <a href="https://store.pikminbloom.com/zh-Hant">
        <img id="biglogo" src='static/images/logo.png' alt='çš®å…‹æ•å¤§logo'>
      </a>
    </div>
  </div>
  
  <h2>GPX é»ä½ç·¨è¼¯å™¨</h2>

  <div id="nameloco">
    <label>åç¨±ï¼š</label>
    <input type="text" id="nameInput" placeholder="ä¾‹å¦‚ï¼šå°ä¸­æ¶ˆæ³¢å¡Š">
    <br>
    <label>ç¶“ç·¯åº¦ï¼š</label>
    <input type="text" id="coordInput" placeholder="24.018417,120.493877">
    <button onclick="addPoint()">æ–°å¢é»ä½</button>
  </div>

  <div id="mapControls">
    <label>
      <input type="checkbox" id="showLineCheckbox" onchange="toggleLine()"> é¡¯ç¤ºé»ä½é€£ç·š
    </label>
    <span id="tips">é»æ“Šåœ°åœ–ä»¥åŠ å…¥åº§æ¨™</span>
    <span  style="display:none" id ="uptips">ä¿®æ”¹åº§æ¨™æ™‚å¯æ‹–æ›³åœ°åœ–ä¸Šçš„æ¨™è¨˜ä¿®æ”¹åº§æ¨™ï¼Œæ‹–æ›³å®Œæˆå¾Œæœƒè‡ªå‹•é–å®š</span>
  </div>

  <div id="map"></div>

<div id="tableContainer">
  <table id="pointTable">
    <thead>
      <tr>
        <th>åç¨±</th>
        <th>ç¶“ç·¯åº¦</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="pointTableBody"></tbody>
  </table>
</div>



  
  <div id="gpxname">

    <label>æª”æ¡ˆåç¨±ï¼š</label>
    <input type="text" id="gpxnameInput" placeholder="è«‹è¼¸å…¥æª”å">
    <button id="downloadBtn" onclick="downloadGPX()">ä¸‹è¼‰ GPX</button>
    <label for="gpxFileInput" class="import-btn">åŒ¯å…¥ GPX </label>
    <input type="file" id="gpxFileInput" accept=".gpx" /> 
    <!-- <button onclick="downloadJoystickGPX()">ä¸‹è¼‰ Joystick GPX</button> å¥½åƒæš«æ™‚ä¸éœ€è¦ä»–-->
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-gpx"></script> <!--è¼‰å…¥gpxçš„å¤–æ›-->

  <script>
  let points = [];
  let markers = [];
  let tempMarker = null;
  let polyline = null;
  let pointCount = 0; // è‡ªå‹•ç·¨è™Ÿç”¨
  let isEditing = false;
  let allowAdd = true; // æ˜¯å¦å…è¨±æ‰‹å‹•æ–°å¢ï¼ˆåŒ¯å…¥æ™‚æœƒæš«æ™‚é—œé–‰ï¼‰

  const uptips = document.getElementById('uptips');
  const tips = document.getElementById('tips');
  const map = L.map('map').setView([23.9739, 120.9820], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap è²¢ç»è€…'
  }).addTo(map);

  // é»æ“Šåœ°åœ– â†’ é¡¯ç¤ºæš«æ™‚æ¨™è¨˜ + åŠ å…¥æŒ‰éˆ•
 map.on('click', function(e) {
  if (!allowAdd) return; // â— åŒ¯å…¥æ™‚ä¸é¡¯ç¤ºæç¤º

  if (isEditing) return;   // â˜… ä¿®æ”¹åº§æ¨™æ™‚ç¦ç”¨æ–°å¢æ¨¡å¼

  const lat = e.latlng.lat.toFixed(6);
  const lon = e.latlng.lng.toFixed(6);
  document.getElementById('coordInput').value = `${lat},${lon}`;

  if (tempMarker) map.removeLayer(tempMarker);

    tempMarker = L.marker([lat, lon]).addTo(map)
      .bindPopup(`<b>æš«æ™‚æ¨™è¨˜</b><br>${lat}, ${lon}<br><button onclick="confirmAddPoint(${lat},${lon})">åŠ å…¥åº§æ¨™</button>`)
      .openPopup();

     // é¡¯ç¤ºæç¤ºï¼ˆä½†åªæœ‰å…è¨±æ–°å¢æ™‚ï¼‰
  if (tips) tips.style.display = 'inline';
});

  // ç¢ºèªæ–°å¢é»
  function confirmAddPoint(lat, lon) {
    pointCount++;
    const name = `é»ä½ ${pointCount}`;
    points.push({ name, lat, lon });
    renderTable();
    renderMarkers();

    map.closePopup();
    map.removeLayer(tempMarker);
    tempMarker = null;
    tips.style.display = 'none';

    // ç¬¬ä¸€å€‹é»è‡ªå‹• zoom in
    if (points.length === 1) {
      map.setView([lat, lon], 15);
    }

    if (document.getElementById('showLineCheckbox').checked) drawLine();
  }

  // æ–°å¢é»ä½ï¼ˆæ‰‹å‹•ï¼‰
  function addPoint() {
    let name = document.getElementById('nameInput').value.trim();
    let coord = document.getElementById('coordInput').value.trim();

    if (!coord) return alert("è«‹è¼¸å…¥ç¶“ç·¯åº¦æˆ–é»æ“Šåœ°åœ–");

    coord = coord.replace(/[()ï¼ˆï¼‰]/g, "").replace(/ï¼Œ/g, ",").replace(/\s+/g, "");
    const [lat, lon] = coord.split(',').map(x => x.trim());
    if (!lat || !lon || isNaN(lat) || isNaN(lon)) return alert("è«‹è¼¸å…¥æ­£ç¢ºæ ¼å¼ï¼Œä¾‹å¦‚ï¼š24.018417,120.493877");

    if (!name) {
      pointCount++;
      name = `é»ä½ ${pointCount}`;
    }

    points.push({ name, lat, lon });
    renderTable();
    renderMarkers();

    document.getElementById('nameInput').value = '';
    document.getElementById('coordInput').value = '';

    if (points.length === 1) map.setView([lat, lon], 15);
    if (document.getElementById('showLineCheckbox').checked) drawLine();
  }

  function renderTable() {
    const tbody = document.querySelector('#pointTable tbody');
    tbody.innerHTML = '';

    points.forEach((p, i) => {
      const coordText = `${p.lat},${p.lon}`;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td contenteditable="true" oninput="updatePoint(${i}, 'name', this.innerText)">${p.name}</td>
        <td contenteditable="true" oninput="updateCoord(${i}, this.innerText)">${coordText}</td>
        <td>
          <button onclick="editCoord(${i})">ä¿®æ”¹åº§æ¨™</button>
          <button onclick="deletePoint(${i})">åˆªé™¤</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function updatePoint(index, key, value) {
    points[index][key] = value.trim();
    renderMarkers();
  }

  function updateCoord(index, value) {
    const [lat, lon] = value.split(',').map(x => x.trim());
    if (!lat || !lon || isNaN(lat) || isNaN(lon)) return;
    points[index].lat = lat;
    points[index].lon = lon;
    renderMarkers();
  }

  function editCoord(index) {
    const marker = markers[index];
    if (!marker) return;
    marker.dragging.enable();
    marker.openPopup();
  }

  //ç·¨è¼¯åç¨±
  function editPointName(index) {
  const newName = prompt("è«‹è¼¸å…¥æ–°çš„åç¨±ï¼š", points[index].name);
  if (newName !== null && newName.trim() !== "") {
    points[index].name = newName.trim();
    renderTable();
    renderMarkers(); // é‡æ–°æ›´æ–°åœ°åœ–é¡¯ç¤º
  }
}

function startEditCoord(index) {
  const marker = markers[index];

  if (!marker) return;

  isEditing = true;   // â˜… é–‹å§‹ä¿®æ”¹æ¨¡å¼
  uptips.style.display = 'inline';
  marker.dragging.enable();
  marker.openPopup();

  marker.once("dragend", function (e) {
    const latlng = e.target.getLatLng();
    points[index].lat = latlng.lat.toFixed(6);
    points[index].lon = latlng.lng.toFixed(6);

    renderTable();
    marker.dragging.disable();

    isEditing = false; // â˜… çµæŸä¿®æ”¹æ¨¡å¼
    uptips.style.display = 'none';

    if (document.getElementById('showLineCheckbox').checked) drawLine();

  });
}
  function deletePoint(index) {
    if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é»å—ï¼Ÿ")) {
      points.splice(index, 1);
      renderTable();
      renderMarkers();
      if (document.getElementById('showLineCheckbox').checked) drawLine();
    }
  }

function renderMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  if (points.length === 0) return;

  points.forEach((p, i) => {
    //å½ˆå‡ºè¦–çª—æœƒé¡¯ç¤º
    function buildPopupHTML(index) {
      return `
        <b>${points[index].name}</b><br>${points[index].lat}, ${points[index].lon}<br>
        <button onclick="editPointName(${index})" style="margin-top:5px;">ä¿®æ”¹åç¨±</button>
        <button onclick="startEditCoord(${index})" style="margin-top:5px;">ä¿®æ”¹åº§æ¨™</button>
        <button onclick="deletePoint(${index})" style="margin-left:5px; color:red;">åˆªé™¤</button>
      `;
    }

    const marker = L.marker([p.lat, p.lon], { draggable: false })
      .bindPopup(buildPopupHTML(i))
      .addTo(map);

    marker.on("dragend", function (e) {
      const latlng = e.target.getLatLng();
      points[i].lat = latlng.lat.toFixed(6);
      points[i].lon = latlng.lng.toFixed(6);

      renderTable();

      // 1. å…ˆé—œé–‰ popupï¼ˆèˆŠå…§å®¹ï¼‰
      marker.closePopup();

      // 2. æ›´æ–° popup å…§å®¹
      marker.unbindPopup(); 
      marker.bindPopup(buildPopupHTML(i));

      // 3. å†é—œä¸€æ¬¡ï¼ˆé¿å… Leaflet çš„å»¶é² popupï¼‰
      setTimeout(() => marker.closePopup(), 10);

      marker.dragging.disable();

      if (document.getElementById('showLineCheckbox').checked) drawLine();
    });

        markers.push(marker);
      });
    }
    // âœ… æ–°å¢é€™æ®µï¼šä¿®æ”¹åç¨±çš„åŠŸèƒ½
function editPointName(index) {
  const newName = prompt("è«‹è¼¸å…¥æ–°çš„åç¨±ï¼š", points[index].name);
  if (newName !== null && newName.trim() !== "") {
    points[index].name = newName.trim();
    renderTable();    // æ›´æ–°è¡¨æ ¼
    renderMarkers();  // é‡æ–°ç•«åœ°åœ–
  }
}


  function toggleLine() {
    if (document.getElementById('showLineCheckbox').checked) {
      drawLine();
    } else {
      if (polyline) {
        map.removeLayer(polyline);
        polyline = null;
      }
    }
  }


  function drawLine() {
    if (polyline) map.removeLayer(polyline);
    if (points.length < 2) return;
    const latlngs = points.map(p => [p.lat, p.lon]);
    polyline = L.polyline(latlngs, { color: 'red', weight: 3 }).addTo(map);
  }

  function downloadGPX() {
    if (points.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯ä»¥ä¸‹è¼‰");
    let filename = document.getElementById('gpxnameInput').value.trim() || "points";
    if (!filename.toLowerCase().endsWith('.gpx')) filename += '.gpx';
    let gpx = `<?xml version="1.0" encoding="utf-8"?>\n<gpx version="1.1" creator="GPX Editor" xmlns="http://www.topografix.com/GPX/1/1">\n`;
    points.forEach(p => {
      gpx += `  <wpt lat="${p.lat}" lon="${p.lon}"><name><![CDATA[${p.name}]]></name></wpt>\n`;
    });
    gpx += `</gpx>`;
    const blob = new Blob([gpx], { type: "application/gpx+xml" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
  }

  function downloadJoystickGPX() {
    if (points.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯ä»¥ä¸‹è¼‰");
  
    let filename = document.getElementById('gpxnameInput').value.trim() || "joystick";
    if (!filename.toLowerCase().endsWith('.gpx')) filename += '.gpx';
  
    let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n`;
    gpx += `<gpx version="1.1" creator="GPS JoyStick - gpsjoystick@gmail.com - https://www.facebook.com/gpsjoystick">\n`;
    gpx += `  <rte>\n`;
  
    points.forEach(p => {
      gpx += `    <rtept lat="${p.lat}" lon="${p.lon}"></rtept>\n`;
    });
  
    gpx += `  </rte>\n`;
    gpx += `</gpx>`;
  
    const blob = new Blob([gpx], { type: "application/gpx+xml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }
    setTimeout(() => {
  map.invalidateSize();
}, 300);

// åŒ¯å…¥ GPX ä¸¦è‡ªå‹•è½‰æ›æˆ wpt
document.getElementById('gpxFileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;
    allowAdd = false; // åŒ¯å…¥æ™‚ä¸å…è¨±æ‰‹å‹•æ–°å¢
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
  }
  if (tips) tips.style.display = 'none'; // ğŸ”¹ éš±è—æç¤º

  const reader = new FileReader();  

  reader.onload = function(e) {
    let gpxData = e.target.result;

    // åˆ¤æ–·æ˜¯å¦æ˜¯ rtept
    if (gpxData.includes("<rtept")) {
      console.log("åµæ¸¬åˆ° <rtept>ï¼Œè‡ªå‹•è½‰æ›ç‚º <wpt>");
      gpxData = gpxData
        .replace(/<rtept/g, "<wpt")
        .replace(/<\/rtept>/g, "</wpt>");
      // åŒæ™‚ä¹Ÿç§»é™¤ <rte> å€å¡ŠåŒ…è£¹ï¼ˆä»¥å…å¹²æ“¾ï¼‰
      gpxData = gpxData.replace(/<rte[^>]*>/g, "").replace(/<\/rte>/g, "");
    }

    // æ¸…ç©ºåŸæœ¬è³‡æ–™
    points = [];
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    if (polyline) {
      map.removeLayer(polyline);
      polyline = null;
    }

    // ä½¿ç”¨ DOMParser è§£æ GPX
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(gpxData, "text/xml");
    const wptNodes = xmlDoc.getElementsByTagName("wpt");

    if (wptNodes.length === 0) {
      alert("GPX æª”æ¡ˆä¸­æ²’æœ‰å¯ç”¨çš„é»ä½ï¼ˆwpt æˆ– rteptï¼‰");
      return;
    }

    // è®€å–æ‰€æœ‰åº§æ¨™é»
    for (let i = 0; i < wptNodes.length; i++) {
      const wpt = wptNodes[i];
      const lat = wpt.getAttribute("lat");
      const lon = wpt.getAttribute("lon");
      let name = "é»ä½ " + (i + 1);
      const nameNode = wpt.getElementsByTagName("name")[0];
      if (nameNode && nameNode.textContent.trim() !== "") {
        name = nameNode.textContent.trim();
      }
      points.push({ name, lat, lon });
    }

    // æ¸²æŸ“åœ°åœ–èˆ‡è¡¨æ ¼
    renderTable();
    renderMarkers();

    allowAdd = true; // åŒ¯å…¥å®Œå†å…è¨±æ‰‹å‹•æ–°å¢

    // èª¿æ•´åœ°åœ–è¦–é‡
    const latlngs = points.map(p => [p.lat, p.lon]);
    const bounds = L.latLngBounds(latlngs);
    map.fitBounds(bounds);
  };

  reader.readAsText(file);
});

  </script>
</body>
</html>
